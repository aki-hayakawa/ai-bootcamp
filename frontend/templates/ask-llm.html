{% extends "base.html" %}
{% block title %}Ask LLM{% endblock %}

{% block content %}
  <h2>Ask the LLM</h2>

  <form id="llmForm" class="mb-4">
    <div class="mb-3">
      <label for="prompt" class="form-label">Prompt</label>
      <textarea id="prompt" name="prompt" class="form-control" rows="4" required></textarea>
    </div>
    <button type="submit" class="btn btn-primary" id="submitBtn">
      Submit
      <span 
        id="spinner" 
        class="spinner-border spinner-border-sm ms-2" 
        role="status" 
        aria-hidden="true" 
        style="display:none;"
      ></span>
    </button>
  </form>

  <hr>

  <div 
    id="response-container" 
    class="fade" 
    style="display: none; opacity: 0;"
  >
    <h4>Response (<span id="source"></span>)</h4>
    <pre class="bg-light p-3 border rounded" id="responseText"></pre>
  </div>

  <script>
    const token = "{{ session.access_token }}";
    const form = document.getElementById("llmForm");
    const btn  = document.getElementById("submitBtn");
    const spinner = document.getElementById("spinner");
    const respCont = document.getElementById("response-container");
    const respText = document.getElementById("responseText");
    const srcSpan  = document.getElementById("source");

    form.addEventListener("submit", async function(e) {
      e.preventDefault();

      // grab & validate
      const prompt = (new FormData(form).get("prompt")||"").trim();
      if (!prompt) {
        alert("Please enter a prompt.");
        return;
      }

      // prepare UI
      btn.disabled = true;
      spinner.style.display = "inline-block";
      // hide previous response
      respCont.classList.remove("show");
      respCont.style.display = "none";

      try {
        // fetch
        const res = await fetch("/ask-llm", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Accept": "application/json",
            "Authorization": `Bearer ${token}`
          },
          body: JSON.stringify({ prompt })
        });

        const data = await res.json().catch(()=>null);
        if (!res.ok) {
          throw new Error(data?.detail || `HTTP ${res.status}`);
        }

        // fill response
        respText.innerText = data.response;
        srcSpan.innerText  = data.source;

        // fade-in
        respCont.style.display = "block";
        // force reflow so transition triggers
        void respCont.offsetWidth;
        respCont.classList.add("show");

      } catch (err) {
        alert("Error: " + err.message);
        console.error(err);
      } finally {
        // restore button
        btn.disabled = false;
        spinner.style.display = "none";
      }
    });
  </script>

  <style>
    /* bootstrapâ€™s .fade + .show gives us a simple fade transition */
    .fade {
      transition: opacity 0.3s ease-in-out;
    }
    .fade.show {
      opacity: 1 !important;
    }
  </style>
{% endblock %}
